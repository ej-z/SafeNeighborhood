<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Safe Neighborhood</title>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
    <script type="text/javascript" src=" https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
   
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>
 
<!-- Include the plugin's CSS and JS: -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css" type="text/css"/>
  </head>
  <body>    
    
    <div>
      <form class="btn-group" id="example-reset-form">
      <div class="btn-group">
      <select name="drop_down" id="dropDownStates" multiple="multiple">
      </select>
      </div>
      </form>

      <form class="btn-group" id="example-zip-code">
        <div class="btn-group">
        <select name="drop_down" id="dropDownZipCodes" multiple="multiple">
        </select>
        </div>
      </form>
     
      <form class="btn-group" id="example-Types">
        <div class="btn-group">
        <select name="drop_down" id="dropDownTypes" multiple="multiple">

        </select>
        </div>
        </form>
        
        <button id="submitBtn" type="button">Submit</button>
      </div>    
    
  

    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>

    <div id="map"></div> 
    
    <script>      
      
      $(document).ready(function(){
        getStates();
        getTypes();
        $("#submitBtn").bind("click", function(){submit()});
        $("#dropDownZipCodes").hide();
      });
      
      var POINTS = []


      function getStates()
      {
        getData("getStates",null, populateStates);  
      }

      function getTypes()
      {
        getData("getTypes",null, populateTypes);  
      }

      function getCategories(type)
      {
        data = {type: type}
        getData("getCategories",data, populateCategories);  
      }
      
      function getZipCodes(state){
        data = {state: state}
        getData("getZipcodes",data, populateZipCodes);
      }

      function populateZipCodes(zipCodes)
      {
        $.each(zipCodes.sort(), function (key, value) {
                  $("#dropDownZipCodes").append($('<option></option>').val(value).html(value));
              });
        $('#dropDownZipCodes').multiselect();
        $('#example-zip-code').on('reset', function() {
            $('#dropDownZipCodes option:selected').each(function() {
                $(this).prop('selected', false);
            })
 
            $('#dropDownZipCodes').multiselect('refresh');
          })
      }

      function populateStates(states)
      {
        $.each(states.sort(), function (key, value) {
                  $("#dropDownStates").append($('<option></option>').val(value).html(value));
              });
        $('#dropDownStates').multiselect();
        $('#example-reset-form').on('reset', function() {
            $('#dropDownStates option:selected').each(function() {
                $(this).prop('selected', false);
            })
 
            $('#dropDownStates').multiselect('refresh');

            
        });

        $('#dropDownStates').change(function () {
                  var state = $(this).val();
                  if(state.length == 1)
                  {
                    $("#dropDownZipCodes").show();
                    getZipCodes(state[0]);
                  }
                  else
                  {
                    $("#dropDownZipCodes").hide();
                  }
              });
      }
      function populateTypes(types)
      {
        $.each(types, function (key,value) {
                  $("#dropDownTypes").append($('<optgroup id="type_'+value.Type+'"> </optgroup>'));
                  $("#type_"+value.Type).attr("label",value.Type)
                  $.each(value.Categories,function(key1,value1)
                  {
                    $("#type_"+value.Type).append($('<option></option>').val(value1).html(value1));
                  }
                );
              });
              $('#dropDownTypes').multiselect({
              enableClickableOptGroups: true});

      }

      function populateCategories(categories)
      {
        $("#dropDownCategories").html('<option value="None" selected="Selected">Select Categories</option>');
        $.each(categories, function (key, value) {
                  $("#dropDownCategories").append($('<option></option>').val(value).html(value));
              }); 
      }

      function submit()
      {
        var states = $("#dropDownStates").val();
        var type = $("#dropDownTypes").val();
        var categories = $("#dropDownCategories").val().join();

        if(states != 'None' && type != 'None' && categories != 'None')
        {
          data = {states: states, type: type, categories: categories}
          getData("getData",data, drawMap); 
        }
      }

      function drawMap(data) {

        var points = []

        $.each(data, function (key, value) {

          var c = Number(value.count);

          while(c-- > 0)
          {
            points.push(new google.maps.LatLng(Number(value.latitude), Number(value.longitude)))
          }
        });

        POINTS = points;

        initMap();
      }

      function initMap() {
              var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center: {lat: 37.090, lng: -95.712},
                mapTypeId: 'terrain'
              });

          heatmap = new google.maps.visualization.HeatmapLayer({
                data: POINTS,
                map: map
              });
            }


      function getData(action, data, callback)
      {
        $.ajax({
            url: "http://localhost:8080/SafeNeighborhoodService/"+action,
            type: "get",
            data: data,
            complete: function (xhr, status) {
                if (status === 'error' || !xhr.responseText) {
                    console.log('error');
                }
                else {
                  callback(xhr.responseJSON);
                }
            }
          });
      }

      
    </script>
     <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDl12iD48YV7PlODYkQKd2kboKnsUQi4yw&libraries=visualization&callback=initMap"
  type="text/javascript"></script>
    
  </body>
</html>